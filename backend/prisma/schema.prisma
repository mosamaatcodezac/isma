// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  superadmin
  admin
  cashier
  warehouse_manager
}

enum RegularUserRole {
  cashier
  warehouse_manager
}

enum PaymentType {
  cash
  bank_transfer
}

enum SaleStatus {
  completed
  pending
  cancelled
}

enum ExpenseCategory {
  rent
  bills
  transport
  salaries
  maintenance
  marketing
  tea
  breakfast
  lunch
  dinner
  refreshment
  other
}

model AdminUser {
  id               String    @id @default(cuid())
  username         String    @unique
  password         String
  role             String    @default("admin") // Can be superadmin, admin, or custom role
  name             String
  email            String?
  profilePicture   String?
  resetToken       String?
  resetTokenExpiry DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@map("admin_users")
}

model User {
  id               String    @id @default(cuid())
  username         String    @unique
  password         String
  role             String    @default("cashier") // Can be cashier, warehouse_manager, or custom role
  name             String
  email            String?
  profilePicture   String?
  permissions      String[]  @default([])
  resetToken       String?
  resetTokenExpiry DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  openingBalances DailyOpeningBalance[]

  @@map("users")
}

model Product {
  id                     String    @id @default(cuid())
  name                   String
  category               String?
  categoryId             String?
  brand                  String?
  brandId                String?
  salePrice              Decimal?  @db.Decimal(10, 2)
  shopQuantity           Int       @default(0)
  warehouseQuantity      Int       @default(0)
  shopMinStockLevel      Int       @default(0)
  warehouseMinStockLevel Int       @default(0)
  minStockLevel          Int       @default(0)
  lowStockNotifiedAt     DateTime?
  model                  String?
  manufacturer           String?
  barcode                String?
  image                  String?
  description            String?
  createdBy              String?
  createdByType          String? // "user" or "admin"
  updatedBy              String?
  updatedByType          String? // "user" or "admin"
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  categoryRef   Category?      @relation(fields: [categoryId], references: [id])
  brandRef      Brand?         @relation(fields: [brandId], references: [id])
  saleItems     SaleItem[]
  purchaseItems PurchaseItem[]

  @@map("products")
}

model Customer {
  id             String   @id @default(cuid())
  name           String
  phone          String
  email          String?
  address        String?
  city           String?
  totalPurchases Decimal  @default(0) @db.Decimal(10, 2)
  dueAmount      Decimal  @default(0) @db.Decimal(10, 2)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  sales Sale[]

  @@map("customers")
}

model Supplier {
  id             String   @id @default(cuid())
  name           String
  phone          String
  email          String?
  address        String?
  totalPurchases Decimal  @default(0) @db.Decimal(10, 2)
  dueAmount      Decimal  @default(0) @db.Decimal(10, 2)
  createdBy      String?
  createdByType  String? // "user" or "admin"
  updatedBy      String?
  updatedByType  String? // "user" or "admin"
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  purchases Purchase[]

  @@unique([name, phone], name: "supplier_name_phone")
  @@map("suppliers")
}

model Sale {
  id               String      @id @default(cuid())
  billNumber       String      @unique
  subtotal         Decimal     @db.Decimal(10, 2)
  discount         Decimal     @default(0) @db.Decimal(10, 2)
  discountType     String?     @default("percent") // "percent" or "value"
  tax              Decimal     @default(0) @db.Decimal(10, 2)
  taxType          String?     @default("percent") // "percent" or "value"
  total            Decimal     @db.Decimal(10, 2)
  paymentType      PaymentType @default(cash)
  payments         Json? // Array of { type: "cash"|"card"|"credit"|"bank_transfer", amount: number, cardId?: string, bankAccountId?: string }
  remainingBalance Decimal     @default(0) @db.Decimal(10, 2)
  cardId           String?
  bankAccountId    String?
  status           SaleStatus  @default(completed)
  customerId       String?
  customerName     String?
  customerPhone    String?
  customerCity     String?
  date             DateTime    @default(now())
  userId           String
  userName         String
  createdBy        String?
  createdByType    String? // "user" or "admin"
  updatedBy        String?
  updatedByType    String? // "user" or "admin"
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  // Note: userId can be from either User or AdminUser table, so no foreign key constraint
  customer            Customer?            @relation(fields: [customerId], references: [id])
  card                Card?                @relation(fields: [cardId], references: [id])
  bankAccount         BankAccount?         @relation(fields: [bankAccountId], references: [id])
  items               SaleItem[]
  balanceTransactions BalanceTransaction[] @relation("SaleBalanceTransactions")

  @@map("sales")
}

model SaleItem {
  id                String   @id @default(cuid())
  saleId            String
  productId         String
  productName       String
  quantity          Int
  shopQuantity      Int      @default(0)
  warehouseQuantity Int      @default(0)
  unitPrice         Decimal  @db.Decimal(10, 2)
  customPrice       Decimal? @db.Decimal(10, 2) // Custom price for customer
  // Dozen support: store what user entered + both single/dozen prices at time of sale
  priceType         String?  @default("single") // "single" or "dozen"
  priceSingle       Decimal? @db.Decimal(10, 2) // per single unit
  priceDozen        Decimal? @db.Decimal(10, 2) // per dozen (12 units)
  discount          Decimal  @default(0) @db.Decimal(10, 2)
  discountType      String?  @default("percent") // "percent" or "value"
  tax               Decimal  @default(0) @db.Decimal(10, 2)
  taxType           String?  @default("percent") // "percent" or "value"
  total             Decimal  @db.Decimal(10, 2)
  fromWarehouse     Boolean  @default(false)
  createdAt         DateTime @default(now())

  sale    Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@map("sale_items")
}

model Expense {
  id            String          @id @default(cuid())
  amount        Decimal         @db.Decimal(10, 2)
  category      ExpenseCategory
  description   String?
  paymentType   PaymentType     @default(cash)
  cardId        String?
  bankAccountId String?
  date          DateTime        @default(now())
  userId        String // userId can be from either User or AdminUser table, so no foreign key constraint
  userName      String
  createdBy     String?
  createdByType String? // "user" or "admin"
  updatedBy     String?
  updatedByType String? // "user" or "admin"
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  card                Card?                @relation(fields: [cardId], references: [id])
  bankAccount         BankAccount?         @relation(fields: [bankAccountId], references: [id])
  balanceTransactions BalanceTransaction[] @relation("ExpenseBalanceTransactions")

  @@map("expenses")
}

enum PurchaseStatus {
  completed
  pending
  cancelled
}

model Purchase {
  id               String         @id @default(cuid())
  supplierId       String?
  supplierName     String
  supplierPhone    String?
  subtotal         Decimal        @db.Decimal(10, 2)
  discount         Decimal        @default(0) @db.Decimal(10, 2)
  discountType     String?        @default("percent") // "percent" or "value"
  tax              Decimal        @default(0) @db.Decimal(10, 2)
  taxType          String?        @default("percent") // "percent" or "value"
  total            Decimal        @db.Decimal(10, 2)
  payments         Json? // Array of { type: "cash"|"card", amount: number, cardId?: string, bankAccountId?: string, date?: string }
  remainingBalance Decimal        @default(0) @db.Decimal(10, 2)
  status           PurchaseStatus @default(completed)
  date             DateTime       @default(now())
  userId           String // userId can be from either User or AdminUser table, so no foreign key constraint
  userName         String
  createdBy        String?
  createdByType    String? // "user" or "admin"
  updatedBy        String?
  updatedByType    String? // "user" or "admin"
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  supplier            Supplier?            @relation(fields: [supplierId], references: [id])
  items               PurchaseItem[]
  balanceTransactions BalanceTransaction[] @relation("PurchaseBalanceTransactions")

  @@map("purchases")
}

model PurchaseItem {
  id                String   @id @default(cuid())
  purchaseId        String
  productId         String
  productName       String
  quantity          Int
  shopQuantity      Int      @default(0)
  warehouseQuantity Int      @default(0)
  cost              Decimal  @db.Decimal(10, 2)
  // Price capture (for convenience in UI/reporting): store both single and dozen prices
  priceType         String?  @default("single") // "single" or "dozen" (what user entered)
  costSingle        Decimal? @db.Decimal(10, 2) // per single unit
  costDozen         Decimal? @db.Decimal(10, 2) // per dozen (12 units)
  discount          Decimal  @default(0) @db.Decimal(10, 2)
  discountType      String?  @default("percent") // "percent" or "value"
  total             Decimal  @db.Decimal(10, 2)
  toWarehouse       Boolean  @default(true)
  createdAt         DateTime @default(now())

  purchase Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  product  Product  @relation(fields: [productId], references: [id])

  @@map("purchase_items")
}

model ShopSettings {
  id                String   @id @default(cuid())
  shopName          String
  logo              String
  contactNumber     String
  email             String
  address           String
  bankAccountNumber String?  @default("")
  bankName          String?  @default("")
  ifscCode          String?  @default("")
  gstNumber         String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("shop_settings")
}

model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  products Product[]

  @@map("categories")
}

model Brand {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  products Product[]

  @@map("brands")
}

model Card {
  id            String   @id @default(cuid())
  name          String
  cardNumber    String?
  bankName      String?
  accountHolder String?
  isDefault     Boolean  @default(false)
  isActive      Boolean  @default(true)
  createdBy     String?
  createdByType String? // "user" or "admin"
  updatedBy     String?
  updatedByType String? // "user" or "admin"
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  sales    Sale[]
  expenses Expense[]

  @@map("cards")
}

model BankAccount {
  id            String   @id @default(cuid())
  accountName   String
  accountNumber String
  bankName      String
  ifscCode      String?  @default("")
  accountHolder String?
  branchName    String?
  isDefault     Boolean  @default(false)
  isActive      Boolean  @default(true)
  createdBy     String?
  createdByType String? // "user" or "admin"
  updatedBy     String?
  updatedByType String? // "user" or "admin"
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  sales              Sale[]
  expenses           Expense[]
  BalanceTransaction BalanceTransaction[]

  @@unique([accountNumber, bankName])
  @@map("bank_accounts")
}

model DailyOpeningBalance {
  id            String   @id @default(cuid())
  date          DateTime @db.Date
  cashBalance   Decimal  @default(0) @db.Decimal(10, 2)
  bankBalances  Json? // Array of { bankAccountId: string, balance: number }
  cardBalances  Json? // Array of { cardId: string, balance: number } (deprecated, use bankBalances)
  notes         String?
  userId        String? // Can be from User or AdminUser table (optional FK constraint)
  userName      String
  createdBy     String?
  createdByType String? // "user" or "admin"
  updatedBy     String?
  updatedByType String? // "user" or "admin"
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User? @relation(fields: [userId], references: [id])

  @@unique([date])
  @@map("daily_opening_balances")
}

model DailyConfirmation {
  id              String    @id @default(cuid())
  date            DateTime  @db.Date
  confirmed       Boolean   @default(false)
  confirmedBy     String? // userId or adminId
  confirmedByType String? // "user" or "admin"
  confirmedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([date])
  @@map("daily_confirmations")
}

model BalanceTransaction {
  id            String   @id @default(cuid())
  date          DateTime @db.Date
  type          String // "income" or "expense"
  amount        Decimal  @db.Decimal(10, 2)
  paymentType   String // "cash" or "bank_transfer"
  bankAccountId String?
  description   String?
  source        String? // e.g., "sale", "purchase_payment", "expense", "opening_balance", "add_opening_balance"
  sourceId      String? // ID of the source record (saleId, expenseId, etc.)
  userId        String
  userName      String
  // Detailed balance tracking
  beforeBalance Decimal? @db.Decimal(10, 2) // Balance before this transaction
  afterBalance  Decimal? @db.Decimal(10, 2) // Balance after this transaction
  changeAmount  Decimal? @db.Decimal(10, 2) // Amount changed (positive for income, negative for expense)
  createdAt     DateTime @default(now())

  bankAccount BankAccount? @relation(fields: [bankAccountId], references: [id])
  // Note: sourceId can reference Sale, Purchase, or Expense based on source field
  // Using optional relations without foreign key constraints for flexibility
  sale        Sale?        @relation("SaleBalanceTransactions", fields: [saleId], references: [id])
  purchase    Purchase?    @relation("PurchaseBalanceTransactions", fields: [purchaseId], references: [id])
  expense     Expense?     @relation("ExpenseBalanceTransactions", fields: [expenseId], references: [id])
  saleId      String?
  purchaseId  String?
  expenseId   String?

  @@index([date])
  @@index([paymentType])
  @@index([bankAccountId])
  @@index([source, sourceId])
  @@map("balance_transactions")
}

model DailyClosingBalance {
  id           String   @id @default(cuid())
  date         DateTime @unique @db.Date
  cashBalance  Decimal  @default(0) @db.Decimal(10, 2)
  bankBalances Json? // Array of { bankAccountId: string, balance: number }
  cardBalances Json? // Array of { cardId: string, balance: number }
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("daily_closing_balances")
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  label       String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("roles")
}
